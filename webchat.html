<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Web Chat - Streaming</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            max-width: 900px;
            height: 95vh;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .message {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .user-message {
            background-color: #f9fafb;
        }
        .model-message {
            background-color: #ffffff;
        }
        .model-icon {
            color: #3b82f6; /* Blue 500 */
        }
        .user-icon {
            color: #10b981; /* Emerald 500 */
        }
    </style>
</head>
<body>

<div id="app" class="chat-container rounded-xl mt-3 overflow-hidden">
    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md flex justify-between items-center">
        <h1 class="text-xl font-bold">Ollama Web Chat</h1>
        <!-- ƒê√£ thay th·∫ø hi·ªÉn th·ªã t√™n m√¥ h√¨nh tƒ©nh b·∫±ng Dropdown -->
        <div id="config-info" class="text-sm font-light flex items-center space-x-2">
            <label for="model-select">Model:</label>
            <select id="model-select" class="text-gray-800 p-1 rounded text-sm bg-white"></select>
        </div>
    </header>

    <!-- Message Area -->
    <div id="message-area" class="message-area p-4 space-y-4">
        <!-- Messages will be appended here -->
        <div class="message model-message rounded-lg shadow-sm">
            <p class="text-gray-800"><span class="font-bold model-icon">ü§ñ</span> Ch√†o m·ª´ng! Vui l√≤ng nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n. ƒê·∫£m b·∫£o Ollama server ƒëang ch·∫°y.</p>
        </div>
    </div>

    <!-- Input Form -->
    <div class="p-4 bg-gray-100 border-t border-gray-200">
        <form id="chat-form" class="flex space-x-3">
            <input type="text" id="user-input" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" required>
            <button type="submit" id="send-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl shadow-md transition duration-150 ease-in-out disabled:bg-indigo-300">
                G·ª≠i
            </button>
        </form>
        <div id="status-message" class="mt-2 text-sm text-center text-gray-500"></div>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH API ---
    const OLLAMA_HOST = "http://localhost:11434"; 
    const API_URL = `${OLLAMA_HOST}/api/generate`;

    // Danh s√°ch c√°c m√¥ h√¨nh c√≥ th·ªÉ ch·ªçn
    const AVAILABLE_MODELS = [
        "deepseek-r1:1.5b", // M√¥ h√¨nh c∆° s·ªü 
        "myai", // M√¥ h√¨nh t√πy ch·ªânh c·ªßa b·∫°n        
    ];
    // T√™n m√¥ h√¨nh m·∫∑c ƒë·ªãnh khi t·∫£i trang
    const DEFAULT_MODEL_NAME = "private-llm";

    // --- DOM Elements ---
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const messageArea = document.getElementById('message-area');
    const sendBtn = document.getElementById('send-btn');
    const statusMessage = document.getElementById('status-message');
    const modelSelect = document.getElementById('model-select'); // L·∫•y element dropdown

    let controller = null; // D√πng ƒë·ªÉ h·ªßy y√™u c·∫ßu (Ctrl+C t∆∞∆°ng ƒë∆∞∆°ng)
    
    // --- H√ÄM KH·ªûI T·∫†O V√Ä TI·ªÜN √çCH UI ---

    // Kh·ªüi t·∫°o Dropdown v·ªõi c√°c m√¥ h√¨nh c√≥ s·∫µn
    function initializeModelSelect() {
        AVAILABLE_MODELS.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            if (model === DEFAULT_MODEL_NAME) {
                option.selected = true;
            }
            modelSelect.appendChild(option);
        });
    }

    // T·ª± ƒë·ªông cu·ªôn xu·ªëng cu·ªëi khu v·ª±c chat
    function scrollToBottom() {
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // Th√™m tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng v√†o giao di·ªán
    function appendUserMessage(text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message user-message rounded-lg shadow-sm';
        msgDiv.innerHTML = `<p class="text-gray-800"><span class="font-bold user-icon">üë§</span> ${text}</p>`;
        messageArea.appendChild(msgDiv);
        scrollToBottom();
    }

    // Th√™m v√† tr·∫£ v·ªÅ ph·∫ßn t·ª≠ tin nh·∫Øn c·ªßa Model (ban ƒë·∫ßu tr·ªëng)
    function createModelMessage() {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message model-message rounded-lg shadow-sm';
        msgDiv.innerHTML = `<p class="text-gray-800"><span class="font-bold model-icon">ü§ñ</span> <span class="response-text"></span></p>`;
        messageArea.appendChild(msgDiv);
        scrollToBottom();
        return msgDiv.querySelector('.response-text');
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† n√∫t G·ª≠i
    function setProcessingState(isProcessing, message = '') {
        sendBtn.disabled = isProcessing;
        userInput.disabled = isProcessing;
        modelSelect.disabled = isProcessing; // V√¥ hi·ªáu h√≥a dropdown khi ƒëang x·ª≠ l√Ω
        statusMessage.textContent = message;
    }

    // --- H√ÄM X·ª¨ L√ù STREAMING ---

    async function streamResponse(prompt) {
        // L·∫•y m√¥ h√¨nh hi·ªán t·∫°i ƒë∆∞·ª£c ch·ªçn t·ª´ dropdown
        const selectedModel = modelSelect.value;
        
        // T·∫°o tin nh·∫Øn Model tr·ªëng v√† l·∫•y reference ƒë·∫øn element ch·ª©a text
        const responseTextElement = createModelMessage();
        setProcessingState(true, 'ƒêang t·∫°o ph·∫£n h·ªìi...');
        
        // T·∫°o AbortController ƒë·ªÉ h·ªßy y√™u c·∫ßu
        controller = new AbortController();
        const signal = controller.signal;

        try {
            const payload = {
                model: selectedModel, // S·ª≠ d·ª•ng model ƒë√£ ch·ªçn
                prompt: prompt,
                stream: true // K√≠ch ho·∫°t streaming
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                signal: signal // G·∫Øn signal ƒë·ªÉ c√≥ th·ªÉ h·ªßy
            });

            if (!response.ok) {
                // ƒê·ªçc l·ªói t·ª´ ph·∫£n h·ªìi n·∫øu c√≥
                const errorText = await response.text();
                responseTextElement.textContent = `[L·ªñI HTTP] ${response.status}: ${errorText.substring(0, 100)}...`;
                setProcessingState(false, 'ƒê√£ x·∫£y ra l·ªói.');
                return;
            }

            // L·∫•y reader ƒë·ªÉ ƒë·ªçc lu·ªìng
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let responseText = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    break;
                }
                
                // Decode v√† x·ª≠ l√Ω t·ª´ng chunk d·ªØ li·ªáu
                const chunk = decoder.decode(value, { stream: true });
                
                // Ollama g·ª≠i c√°c ƒë·ªëi t∆∞·ª£ng JSON tr√™n m·ªói d√≤ng, ƒë∆∞·ª£c ph√¢n t√°ch b·∫±ng '\n'
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.trim() === '') continue;

                    try {
                        const data = JSON.parse(line);
                        if (data.response) {
                            responseText += data.response;
                            // C·∫≠p nh·∫≠t giao di·ªán v·ªõi text m·ªõi nh·∫•t
                            responseTextElement.textContent = responseText;
                            scrollToBottom();
                        }
                        if (data.done) {
                            reader.releaseLock();
                            return; // D·ª´ng v√≤ng l·∫∑p sau khi nh·∫≠n done: true
                        }
                    } catch (e) {
                        console.error("L·ªói ph√¢n t√≠ch JSON trong stream:", e, line);
                        // B·ªè qua d√≤ng l·ªói v√† ti·∫øp t·ª•c
                    }
                }
            }
            
        } catch (error) {
            if (error.name === 'AbortError') {
                responseTextElement.textContent += "\n[ƒê√£ H·ª¶Y] Y√™u c·∫ßu ƒë√£ b·ªã h·ªßy b·ªüi ng∆∞·ªùi d√πng.";
                console.log("Y√™u c·∫ßu b·ªã h·ªßy.");
            } else {
                responseTextElement.textContent = `[L·ªñI K·∫æT N·ªêI] Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Ollama. L·ªói: ${error.message}`;
                console.error("L·ªói Fetch:", error);
            }
        } finally {
            setProcessingState(false, 'Ho√†n th√†nh.');
            controller = null; // ƒê·∫∑t l·∫°i controller
        }
    }

    // --- X·ª¨ L√ù S·ª∞ KI·ªÜN ---

    // X·ª≠ l√Ω s·ª± ki·ªán g·ª≠i form
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const prompt = userInput.value.trim();
        if (prompt === "") return;

        // X·ª≠ l√Ω l·ªánh tho√°t t∆∞∆°ng ƒë∆∞∆°ng
        if (prompt.toLowerCase() === 'exit' || prompt.toLowerCase() === 'quit') {
            appendUserMessage(prompt);
            const msgDiv = createModelMessage();
            msgDiv.textContent = "ƒê√£ tho√°t phi√™n tr√≤ chuy·ªán. Vui l√≤ng l√†m m·ªõi trang ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.";
            userInput.value = '';
            setProcessingState(true); // V√¥ hi·ªáu h√≥a input sau khi tho√°t
            return;
        }

        appendUserMessage(prompt);
        userInput.value = '';
        streamResponse(prompt);
    });

    // L·∫Øng nghe s·ª± ki·ªán Ctrl+C (KeyboardInterrupt) ƒë·ªÉ h·ªßy y√™u c·∫ßu
    document.addEventListener('keydown', (e) => {
        // Ki·ªÉm tra Ctrl+C (ho·∫∑c Cmd+C tr√™n Mac)
        if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
            e.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
            if (controller) {
                controller.abort(); // H·ªßy y√™u c·∫ßu ƒëang ch·ªù x·ª≠ l√Ω
                setProcessingState(false, 'Y√™u c·∫ßu ƒë√£ b·ªã h·ªßy (Ctrl+C).');
            } else {
                // X·ª≠ l√Ω n·∫øu ng∆∞·ªùi d√πng nh·∫•n Ctrl+C khi kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·∫°y
                const msgDiv = createModelMessage();
                msgDiv.textContent = "[C·∫¢NH B√ÅO] Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·∫°y ƒë·ªÉ h·ªßy.";
                setTimeout(() => {
                    msgDiv.remove();
                }, 3000);
            }
        }
    });

    // Kh·ªüi t·∫°o dropdown khi trang t·∫£i xong
    window.onload = initializeModelSelect;

</script>

</body>
</html>